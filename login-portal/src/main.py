import time
import logging
from models import LoginCredentials
from portal_agent import PortalAgent
import os
from dotenv import load_dotenv
load_dotenv()

logger = logging.getLogger(__name__)

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def main():
    # Import your LLM client
    from llm import gpt_4o
    
    # Portal URL
    portal_url = os.environ.get("PORTAL_URL")

    credentials = LoginCredentials(
        username= os.environ.get("USERNAME"),
        password= os.environ.get("PASSWORD")
    )
    

    # portal_url = "https://nola.nextrequest.com/"
    
    # # Credentials (optional)
    # credentials = LoginCredentials(
    #     username="",
    #     password="")

    
    # User information for requests
    user_info = {
        'first_name': 'Ayyub',
        'last_name': 'Ibrahim',
        'email': 'ayyub.ibrahimi@gmail.com',
        'phone': '555-123-4567',
        'organization': 'Independent Researcher'
    }
    
    print("\n" + "="*80)
    print("üöÄ ALAMEDA COUNTY PORTAL AUTOMATION SYSTEM")
    print("="*80)
    print("Features:")
    print("  ‚úÖ Portal access and login")
    print("  ‚úÖ AI-powered request generation")
    print("  ‚úÖ Automated form submission")
    print("  ‚úÖ üß† Intelligent request analysis")
    print("  ‚úÖ üéØ Interactive request selection (NEW!)")
    print("  ‚úÖ Screenshot documentation")
    print("="*80)
    
    # Run the session
    with PortalAgent(gpt_4o, headless=False) as agent:  # Using gpt_4o for better analysis
        
        # Step 1: Access portal and login
        print("\nüîê PHASE 1: PORTAL ACCESS & LOGIN")
        print("-" * 50)
        
        results = agent.access_portal_session(
            portal_url=portal_url,
            credentials=credentials
        )
        
        # Display login results
        print(f"\nüìä LOGIN RESULTS:")
        print(f"Portal URL: {portal_url}")
        print(f"Navigation successful: {results.get('navigation', {}).get('success', False)}")
        
        if 'navigation' in results and results['navigation']['success']:
            nav = results['navigation']
            print(f"‚úÖ Successfully accessed portal")
            print(f"Final URL: {nav['url']}")
            print(f"Page title: {nav['title']}")
            print(f"Page type: {nav['analysis'].page_type}")
            print(f"Login required: {nav['analysis'].login_required}")
            print(f"Key elements: {nav['analysis'].key_elements}")
        else:
            print(f"‚ùå Failed to access portal")
            if 'error' in results.get('navigation', {}):
                print(f"Error: {results['navigation']['error']}")
            return
        
        # Check login status
        login_successful = False
        if 'login' in results:
            if results['login'].get('skipped'):
                print(f"Login skipped: {results['login']['reason']}")
                login_successful = True  # Assume we're logged in if login was skipped
            else:
                success = results['login'].get('success', False)
                print(f"Login successful: {success}")
                login_successful = success
                
                if not success and 'error' in results['login']:
                    print(f"Login error: {results['login']['error']}")
        
        print(f"Total screenshots taken: {len(agent.screenshot_manager.screenshots)}")
        
        # Main menu for logged-in users
        if login_successful and agent.is_logged_in:
            while True:
                try:
                    print("\n" + "="*80)
                    print("üéØ CHOOSE YOUR ACTION")
                    print("="*80)
                    print("1. üìù Submit a new public records request") # works
                    print("2. üéØ Analyze specific requests")
                    print("3. üìä Quick overview of all requests") # works 
                    print("4. üß† Detailed analysis of all requests")  # TODO goes in infinite look
                    print("5. üö® Quick check for urgent requests") # works 
                    print("6. üìà Generate comprehensive status report") # works
                    print("7. üö™ Exit")
                    print("-" * 80)
                    
                    choice = input("Enter your choice (1-7): ").strip()
                    
                    if choice == '1':
                        # PHASE 2: Submit new request
                        print("\nüìù PHASE 2: PUBLIC RECORDS REQUEST SUBMISSION")
                        print("-" * 50)
                        
                        user_topic = input("üîç Enter your request topic: ").strip()
                        if not user_topic:
                            print("Please enter a topic")
                            continue
                        
                        print(f"\nüöÄ Processing request for: '{user_topic}'")
                        request_result = agent.submit_public_records_request(user_topic, user_info)
                        
                        if request_result['success']:
                            print("‚úÖ Request submitted successfully!")
                            if 'submission_result' in request_result:
                                submission = request_result['submission_result']
                                print(f"Steps completed: {', '.join(submission.get('steps_completed', []))}")
                                if 'confirmation' in submission:
                                    print(f"Confirmation: {submission['confirmation']}")
                        else:
                            print("‚ùå Request submission failed")
                            if 'errors' in request_result:
                                print(f"Errors: {', '.join(request_result['errors'])}")
                    
                    elif choice == '2':
                        # PHASE 3 INTERACTIVE: Choose specific requests
                        print("\nüéØ PHASE 3 INTERACTIVE: ANALYZE SPECIFIC REQUESTS")
                        print("-" * 50)
                        print("This will show you all available requests and let you choose which ones to analyze with AI...")
                        print("You'll get detailed correspondence summaries and status updates!")
                        
                        try:
                            interactive_result = agent.analyze_specific_requests()
                            
                            if interactive_result['success']:
                                print("\n‚úÖ Interactive analysis completed successfully!")
                                
                                # Display summary based on analysis type
                                if interactive_result.get('analysis_type') == 'multi_request':
                                    total = interactive_result.get('total_requests', 0)
                                    successful = interactive_result.get('successful_analyses', 0)
                                    failed = interactive_result.get('failed_analyses', 0)
                                    
                                    print(f"üìä Analyzed {successful}/{total} requests successfully")
                                    if failed > 0:
                                        print(f"‚ö†Ô∏è  {failed} requests failed to analyze")
                                
                            else:
                                print(f"‚ùå Interactive analysis failed: {interactive_result['error']}")
                                
                        except Exception as e:
                            print(f"‚ùå Interactive analysis error: {str(e)}")
                    
                    elif choice == '3':
                        # PHASE 3: Quick overview
                        print("\nüìä PHASE 3: QUICK OVERVIEW OF ALL REQUESTS")
                        print("-" * 50)
                        print("Getting a quick overview of all your requests...")
                        
                        analysis_result = agent.analyze_existing_requests(detailed_analysis=False)
                        
                        if analysis_result['success']:
                            print("‚úÖ Quick overview completed!")
                            agent.display_requests_summary(analysis_result)
                        else:
                            print(f"‚ùå Overview failed: {analysis_result['error']}")
                    
                    elif choice == '4':
                        # PHASE 3: Detailed analysis of all requests
                        print("\nüß† PHASE 3: DETAILED ANALYSIS OF ALL REQUESTS")
                        print("-" * 50)
                        print("This will analyze ALL requests in detail using AI (may take longer)...")
                        print("Each request will be opened and analyzed for correspondence, status, and actions needed.")
                        
                        confirm = input("\nThis may take several minutes. Continue? (y/n): ").strip().lower()
                        if confirm != 'y':
                            print("Analysis cancelled.")
                            continue
                        
                        analysis_result = agent.analyze_existing_requests(detailed_analysis=True)
                        
                        if analysis_result['success']:
                            print("‚úÖ Detailed analysis completed!")
                            agent.display_requests_summary(analysis_result)
                            print("\nüìÑ Detailed reports saved to files!")
                        else:
                            print(f"‚ùå Detailed analysis failed: {analysis_result['error']}")
                    
                    elif choice == '5':
                        # Quick urgent check
                        print("\nüö® CHECKING FOR URGENT REQUESTS")
                        print("-" * 50)
                        print("Scanning for requests that need your immediate attention...")
                        
                        urgent_result = agent.get_urgent_requests_summary()
                        
                        if urgent_result['success']:
                            urgent_count = urgent_result.get('urgent_count', 0)
                            
                            if urgent_count > 0:
                                print(f"üîî Found {urgent_count} requests needing attention:")
                                print("-" * 60)
                                for req in urgent_result.get('urgent_requests', []):
                                    print(f"üìã {req['request_number']}: {req['status']}")
                                    print(f"üîî Action: {req['action_needed']}")
                                    print(f"üéØ Next: {req['next_steps']}")
                                    print("-" * 40)
                            else:
                                print("‚úÖ No urgent requests found - all good!")
                                print("All your requests are progressing normally.")
                        else:
                            print(f"‚ùå Could not check urgent requests: {urgent_result['error']}")
                    
                    elif choice == '6':
                        # Comprehensive status report
                        print("\nüìà GENERATING COMPREHENSIVE STATUS REPORT")
                        print("-" * 50)
                        print("This will create a detailed report of ALL your requests with AI analysis...")
                        print("The report will include correspondence summaries, timelines, and recommendations.")
                        
                        confirm = input("\nThis comprehensive analysis may take several minutes. Continue? (y/n): ").strip().lower()
                        if confirm != 'y':
                            print("Report generation cancelled.")
                            continue
                        
                        analysis_result = agent.analyze_existing_requests(detailed_analysis=True)
                        
                        if analysis_result['success']:
                            print("‚úÖ Comprehensive status report generated successfully!")
                            agent.display_requests_summary(analysis_result)
                            
                            print("\nüìÅ REPORT FILES GENERATED:")
                            print("   üìä alameda_requests_analysis_[timestamp].json - Detailed data")
                            print("   üìÑ alameda_requests_report_[timestamp].txt - Human-readable report")
                            print("   üì∏ Screenshots of all analyzed pages")
                            print("\nüí° TIP: Check your project directory for these files!")
                        else:
                            print(f"‚ùå Report generation failed: {analysis_result['error']}")
                    
                    elif choice == '7':
                        print("üëã Goodbye! Thanks for using the Alameda County Portal Automation System!")
                        break
                    
                    else:
                        print("‚ùå Invalid choice. Please enter a number between 1-7.")
                        continue
                    
                    # Ask if user wants to continue
                    if choice != '7':
                        print("\n" + "="*60)
                        continue_choice = input("üîÑ Return to main menu? (y/n): ").strip().lower()
                        if continue_choice != 'y':
                            print("üëã Goodbye!")
                            break
                        
                except KeyboardInterrupt:
                    print("\n\nüëã Operation cancelled. Goodbye!")
                    break
                except Exception as e:
                    print(f"\n‚ùå Unexpected error: {str(e)}")
                    print("Please try again or choose a different option.")
                    continue
        
        else:
            print("\n‚ö†Ô∏è  LOGIN REQUIRED")
            print("To use the portal features, ensure login credentials are correct and try again.")
            print("The system requires authentication to access and analyze your public records requests.")
        
        # Final status
        status = agent.get_portal_status()
        print(f"\nüìà FINAL SESSION STATUS:")
        print("=" * 50)
        print(f"üîê Logged in: {status['is_logged_in']}")
        print(f"üöÄ Request functionality: {status['request_functionality_available']}")
        print(f"üì∏ Screenshots captured: {status['total_screenshots']}")
        print(f"üåê Current URL: {status['current_url']}")
        print("=" * 50)
        
        print("\nüìÅ CHECK GENERATED FILES:")
        print("   üìã alameda_portal_session_[timestamp].json - Session data")
        print("   üìÑ alameda_portal_summary_[timestamp].txt - Session summary")
        print("   üìä alameda_requests_analysis_[timestamp].json - Request analysis (if Phase 3 used)")
        print("   üìà alameda_requests_report_[timestamp].txt - Status report (if Phase 3 used)")
        print("   üéØ alameda_interactive_analysis_[timestamp].json - Interactive analysis (if used)")
        print("   üì∏ Screenshots folder - All captured screenshots")
        
        print(f"\nüéâ Session completed successfully! All files saved to your project directory.")

if __name__ == "__main__":
    main()